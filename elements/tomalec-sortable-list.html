<link rel="import" href="../bower_components/polymer/polymer.html">


<polymer-element name="tomalec-sortable-list" attributes="order orderArray">
	<template>
		<link rel="stylesheet" href="tomalec-sortable-list.css">
		<content></content>
	</template>
	 <script>
        Polymer('tomalec-sortable-list', {
            order: "",

            dragged: null,

            orderChanged: function orderChanged( from, to, what){
                // debugger
                // console.warn("orderChanged", this, from, to, what);
                var orderArray = to.split(","),
                    listItems = this.children;
                    len = orderArray.length

                while(len--){
                    currentItem = listItems[len];
                    currentItem.style.order = orderArray[len];
                }
            },
            ready: function () {
                var orderArray = [], len;

                if( this.order=="" && this.childElementCount >0 ){
                    len = this.childElementCount;
                    while (len--) {
                      orderArray[len] = len
                    }
                    this.order = orderArray.join(",");
                }

                this.makeDraggable();
            },
            makeDraggable: function() {
                //d console.info("makeDraggable", this, arguments)
                //debugger
                var listItems, len, currentItem;
                //debugger
                listItems = this.children;
                len = listItems.length;
                //TODO: rewrite it to mutation observer, so it will work also for items added in fly.
                while(len--){
                    currentItem = listItems[len];
                    //currentItem.draggable = (listItems[len].getAttribute("sortable")!=="false");
                    if( listItems[len].getAttribute("sortable") !== "false" ){
                        currentItem.draggable = true;
                        currentItem.addEventListener('dragstart', this.dragStart.bind(this), false);
                        currentItem.addEventListener('dragenter', this.dragEnter.bind(this), false);
                        currentItem.addEventListener('dragover', this.dragOver.bind(this), false);
                        currentItem.addEventListener('dragleave', this.dragLeave.bind(this), false);
                        currentItem.addEventListener('drop', this.drop.bind(this), false);
                        currentItem.addEventListener('dragend', this.dragEnd.bind(this), false);
                    }
                }
            },
            dragStart: function dragStart(event) {
            	//d console.log("dragStart", this, arguments);
                if (event.stopPropagation)
                    event.stopPropagation();
                event.currentTarget.classList.add('move');
                event.dataTransfer.effectAllowed = 'move';
                //debugger
                event.dataTransfer.setData('flextasks/from', event.currentTarget.style.order);

                this.dragged = event.currentTarget.style.order;
                //d console.log('start dragging this.dragged', event.currentTarget.style.order, this)
            
            },
            dragEnter: function dragEnter(event) {
            	//d console.log("dragEnter", event.target, event.currentTarget, this, arguments);
                if (event.stopPropagation)
                    event.stopPropagation();
                event.currentTarget.classList.add('over');
            },
            dragOver: function dragOver(event) {
            	//d console.log("dragOver", this, arguments);
                if (event.preventDefault) {
                    event.preventDefault();
                }
                event.dataTransfer.dropEffect = 'move';   
            },
            dragLeave: function dragLeave(event) {
            	//d console.log("dragLeave", event.target, event.currentTarget, this, arguments);
                if (event.stopPropagation)
                    event.stopPropagation();
                event.currentTarget.classList.remove('over');
                event.currentTarget.classList.remove('move');
            },
            drop: function drop(event) {
                //d console.log("drop this.dragged",  this.dragged, this);
                var from = event.dataTransfer.getData('flextasks/from');
                //debugger;
                event.currentTarget.classList.remove('over');
                
                
                if( this.dragged && //if there is something beeing dragged for this instance
                    event.currentTarget.draggable && //paranoid check for text selection
                    !isNaN(parseInt(from),10) ){
                    event.stopPropagation();
                    console.log("drop", this, arguments, 'from',from, 'to', event.currentTarget.style.order, this.dragged,this.childElementCount);
                    this.moveItem( this.dragged, event.currentTarget.style.order);
                    this.dragged = null;
                }
                return false;
            },
            dragEnd: function(event) {
            	//d console.log("dragEnd", this, arguments);
            },

            moveItem: function moveItem(from, to){
                console.log("move", from, to, this)
            	var orderArray, len;
            	if( from == to ){
            		return;
            	}
            	orderArray = this.order.split(",");
            	len = orderArray.length;
            	if (from < to){
            		while(len--){
            			if( orderArray[len] > from && orderArray[len] < to){
            				orderArray[len]--;
            			} else if (orderArray[len] == from){
            				orderArray[len]  = to - 1;
            			}
            			
            		}
            	} else {
            		while(len--){
            			if( orderArray[len] >= to && orderArray[len] < from){
            				orderArray[len]++;
            			} else if (orderArray[len] == from){
            				orderArray[len] = to;
            			}
            			
            		}
            	}
                this.order = orderArray.join(",");

                //d console.log("moved", this.order );
                this.fire('change', {from: from, to: to, orderArray: orderArray}, null, false);

            }


        });
    </script>
</polymer-element>