<link rel="import" href="../bower_components/polymer/polymer.html">


<polymer-element name="tomalec-sortable-list" attributes="data src">
	<template>
		<link rel="stylesheet" href="tomalec-sortable-list.css">
		<content></content>
	</template>
	 <script>
        Polymer('tomalec-sortable-list', {
        	order: null,

            dragged: null,

            ready: function () {
                this.makeDraggable();
            },
            makeDraggable: function() {
                //d console.info("makeDraggable", this, arguments)
                //debugger
                var listItems, len, currentItem;
                //debugger
                listItems = this.children;
                len = listItems.length;
                while(len--){
                    currentItem = listItems[len];
                    //currentItem.draggable = (listItems[len].getAttribute("sortable")!=="false");
                    if( listItems[len].getAttribute("sortable") !== "false" ){
                        currentItem.draggable = true;
                        currentItem.addEventListener('dragstart', this.dragStart.bind(this), false);
                        currentItem.addEventListener('dragenter', this.dragEnter.bind(this), false);
                        currentItem.addEventListener('dragover', this.dragOver.bind(this), false);
                        currentItem.addEventListener('dragleave', this.dragLeave.bind(this), false);
                        currentItem.addEventListener('drop', this.drop.bind(this), false);
                        currentItem.addEventListener('dragend', this.dragEnd.bind(this), false);
                    }
                }
            },
            dragStart: function dragStart(event) {
            	//d console.log("dragStart", this, arguments);
                if (event.stopPropagation)
                    event.stopPropagation();
                event.currentTarget.classList.add('move');
                event.dataTransfer.effectAllowed = 'move';
                //debugger
                event.dataTransfer.setData('flextasks/from', event.currentTarget.style.order);

                this.dragged = event.currentTarget.style.order;
                //d console.log('start dragging this.dragged', event.currentTarget.style.order, this)
            
            },
            dragEnter: function dragEnter(event) {
            	//d console.log("dragEnter", event.target, event.currentTarget, this, arguments);
                if (event.stopPropagation)
                    event.stopPropagation();
                event.currentTarget.classList.add('over');
            },
            dragOver: function dragOver(event) {
            	//d console.log("dragOver", this, arguments);
                if (event.preventDefault) {
                    event.preventDefault();
                }
                event.dataTransfer.dropEffect = 'move';   
            },
            dragLeave: function dragLeave(event) {
            	//d console.log("dragLeave", event.target, event.currentTarget, this, arguments);
                if (event.stopPropagation)
                    event.stopPropagation();
                event.currentTarget.classList.remove('over');
                event.currentTarget.classList.remove('move');
            },
            drop: function drop(event) {
                //d console.log("drop this.dragged",  this.dragged, this);
                var from = event.dataTransfer.getData('flextasks/from');
                //debugger;
                event.currentTarget.classList.remove('over');
                
                
                if( this.dragged && //if there is something beeing dragged for this instance
                    event.currentTarget.draggable && //paranoid check for text selection
                    !isNaN(parseInt(from),10) ){
                    event.stopPropagation();
                    console.log("drop", this, arguments, 'from',from, 'to', event.currentTarget.style.order, this.dragged,this.childElementCount);
                    this.moveItem( this.dragged, event.currentTarget.style.order);
                    this.dragged = null;
                }
                return false;
            },
            dragEnd: function(event) {
            	//d console.log("dragEnd", this, arguments);
            },

            moveItem: function moveItem(from, to){
                //d console.log("move", from, to, this)
            	var listItems, len, currentItem, newOrder=[];
            	if( from == to ){
            		return;
            	}
            	listItems = this.children;
            	len = listItems.length;
            	if (from < to){
            		while(len--){
            			currentItem = listItems[len];
            			if( currentItem.style.order > from && currentItem.style.order < to){
            				currentItem.style.order --;
            			} else if (currentItem.style.order == from){
            				currentItem.style.order  = to - 1;
            			}
                        newOrder.push(currentItem.style.order);
            			
            		}
            	} else {
            		while(len--){
            			currentItem = listItems[len];
            			if( currentItem.style.order >= to && currentItem.style.order < from){
            				currentItem.style.order++;
            			} else if (currentItem.style.order == from){
            				currentItem.style.order = to;
            			}
                        newOrder.push(currentItem.style.order);
            			
            		}
            	}
                this.order = newOrder.reverse();

                //d console.log("moved", this.order );
                this.fire('change', {from: from, to: to, order: this.order}, null, false);

            }


        });
    </script>
</polymer-element>