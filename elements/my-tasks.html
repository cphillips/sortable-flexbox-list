<link rel="import" href="../bower_components/polymer/polymer.html">


<polymer-element name="my-tasks" attributes="data src">
	<template>
		<link rel="stylesheet" href="my-tasks.css">
		<ol id="todolist" draggable="false">
			<content></content>
		</ol>
	</template>
	 <script>
        Polymer('my-tasks', {
        	order: null,

            ready: function () {
                this.makeDraggable();
            },
            makeDraggable: function() {
                console.info("makeDraggable", this, arguments)
                //debugger
                var drag = this.$.todolist;
                drag.addEventListener('dragstart', this.dragStart.bind(this), false);    
                drag.addEventListener('dragenter', this.dragEnter.bind(this), false);    
                drag.addEventListener('dragover', this.dragOver.bind(this), false);    
                drag.addEventListener('dragleave', this.dragLeave.bind(this), false);    
                drag.addEventListener('drop', this.drop.bind(this), false);    
                drag.addEventListener('dragend', this.dragEnd.bind(this), false);
            },
            dragStart: function dragStart(event) {
            	console.log("dragStart", this, arguments);
                event.target.classList.add('move');
                if (event.stopPropagation)
                    event.stopPropagation();
                event.dataTransfer.effectAllowed = 'move';
                //debugger
                event.dataTransfer.setData('flextasks/from', event.target.style.order);
            },
            dragEnter: function dragEnter(event) {
            	console.log("dragEnter", event.target, event.currentTarget, this, arguments);
              //  var id = event.dataTransfer.getData('flextasks/from');
                if (event.stopPropagation)
                    event.stopPropagation();
                event.target.classList.add('over');
            },
            dragOver: function dragOver(ev) {
            	//console.log("dragOver", this, arguments);

                if (ev.preventDefault) {
                    ev.preventDefault();
                }
                ev.dataTransfer.dropEffect = 'move';   
            },
            dragLeave: function dragLeave(ev) {
            	console.log("dragLeave", this, arguments);
            	
                if (ev.stopPropagation)
                    ev.stopPropagation();
                event.target.classList.remove('over');
                event.target.classList.remove('move');
            },
            drop: function drop(event) {
                var from = event.dataTransfer.getData('flextasks/from');

                if (event.stopPropagation)
                    event.stopPropagation();
                event.target.classList.remove('over');

            	console.log("drop", this, arguments, from, event.target.style.order);
            	this.moveItem( from, event.target.style.order);
                return false;
            },
            dragEnd: function(ev) {
            	//console.log("dragEnd", this, arguments);
            },

            moveItem: function moveItem(from, to){
            	var listItems, len, currentItem, newOrder=[];
            	if( from == to ){
            		return;
            	}
                //debugger
            	listItems = this.children;
            	len = listItems.length;
            	if (from < to){
            		while(len--){
            			currentItem = listItems[len];
            			if( currentItem.style.order > from && currentItem.style.order < to){
            				currentItem.style.order --;
            			} else if (currentItem.style.order == from){
            				currentItem.style.order  = to - 1;
            			}
                        newOrder.push(currentItem.style.order);
            			
            		}
            	} else {
            		while(len--){
            			currentItem = listItems[len];
            			if( currentItem.style.order >= to && currentItem.style.order < from){
            				currentItem.style.order++;
            			} else if (currentItem.style.order == from){
            				currentItem.style.order = to;
            			}
                        newOrder.push(currentItem.style.order);
            			
            		}
            	}
                this.order = newOrder.reverse();
                this.fire('change', {from: from, to: to, order: this.order}, null, false);

            }


        });
    </script>
</polymer-element>