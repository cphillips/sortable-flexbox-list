<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/polymer-ajax/polymer-ajax.html">

<link rel="import" href="my-item.html">

<polymer-element name="my-tasks" attributes="data src">
	<template>
		<link rel="stylesheet" href="my-tasks.css">


		<section id="todoapp">
			<section id="main" hidden?="{{data.tasks.length == 0}}">
			<ol id="todolist" draggable="false">
				<template repeat="{{ item, index in data.tasks }}">
					<li draggable="true" data-index="{{index}}" style="order: {{item.userOrder$}};">{{item.desc}}</li>
				</template>
			</ol>
			</section>
			<footer id="footer" hidden?="{{data.tasks.length == 0}}">
				<span id="todo-count">Curent order: <strong><template repeat="{{data.tasks}}">{{userOrder$}} </template></strong></span>
			</footer>
		</section>
	</template>
	 <script>
        Polymer('my-tasks', {
        	data: null,

            ready: function () {
                this.data = this.data || 
                {
					"tasks": [{
						"desc": "one",
                        "userOrder$": 0
					}, {
						"desc": "two",
                        "userOrder$": 1
					}, {
						"desc": "three",
                        "userOrder$": 2
					}, {
						"desc": "four",
                        "userOrder$": 3
					}, {
						"desc": "five",
                        "userOrder$": 4
					}, {
						"desc": "six",
                        "userOrder$": 5
					}, {
						"desc": "seven",
                        "userOrder$": 6
					}, {
						"desc": "eight",
                        "userOrder$": 7
					}]
				};
            },
            dataChanged: function () {
                console.info("dataChanged", this, arguments)
                if(this.data != null && this.data != ""){
                        this.makeDraggable();
                }
            },
            makeDraggable: function() {
                console.info("makeDraggable", this, arguments)
                //debugger
                var drag = this.$.todolist;
                drag.addEventListener('dragstart', this.dragStart.bind(this), false);    
                drag.addEventListener('dragenter', this.dragEnter.bind(this), false);    
                drag.addEventListener('dragover', this.dragOver.bind(this), false);    
                drag.addEventListener('dragleave', this.dragLeave.bind(this), false);    
                drag.addEventListener('drop', this.drop.bind(this), false);    
                drag.addEventListener('dragend', this.dragEnd.bind(this), false);
            },
            dragStart: function dragStart(event) {
            	console.log("dragStart", this, arguments);
                event.target.classList.add('move');
                if (event.stopPropagation)
                    event.stopPropagation();
                event.dataTransfer.effectAllowed = 'move';
                //debugger
                event.dataTransfer.setData('flextasks/from', event.target.style.order);
            },
            dragEnter: function dragEnter(event) {
            	console.log("dragEnter", event.target, event.currentTarget, this, arguments);
              //  var id = event.dataTransfer.getData('flextasks/from');
                if (event.stopPropagation)
                    event.stopPropagation();
                event.target.classList.add('over');
            },
            dragOver: function dragOver(ev) {
            	//console.log("dragOver", this, arguments);

                if (ev.preventDefault) {
                    ev.preventDefault();
                }
                ev.dataTransfer.dropEffect = 'move';   
            },
            dragLeave: function dragLeave(ev) {
            	console.log("dragLeave", this, arguments);
            	
                if (ev.stopPropagation)
                    ev.stopPropagation();
                event.target.classList.remove('over');
                event.target.classList.remove('move');
            },
            drop: function drop(event) {
                var from = event.dataTransfer.getData('flextasks/from');

                if (event.stopPropagation)
                    event.stopPropagation();
                event.target.classList.remove('over');

            	console.log("drop", this, arguments, from, event.target.style.order);
            	this.moveItem( from, event.target.style.order);
                console.info(this.data)
                //this.data.tasks[0]["userOrder$"]=1000;
                return false;
            },
            dragEnd: function(ev) {
            	//console.log("dragEnd", this, arguments);
            },

            moveItem: function moveItem(from, to){
            	var listItems, len, currentItem;
            	if( from == to ){
            		return;
            	}

            	listItems = this.data.tasks;
            	len = listItems.length;
            	if (from < to){
            		while(len--){
            			currentItem = listItems[len];
            			if( currentItem.userOrder$ > from && currentItem.userOrder$ < to){
            				currentItem.userOrder$ --;
            			} else if (currentItem.userOrder$ == from){
            				currentItem.userOrder$  = to - 1;
            			}
            			
            		}
            	} else {
            		while(len--){
            			currentItem = listItems[len];
            			if( currentItem.userOrder$ >= to && currentItem.userOrder$ < from){
            				currentItem.userOrder$++;
            			} else if (currentItem.userOrder$ == from){
            				currentItem.userOrder$ = to;
            			}
            			
            		}
            	}

            }


        });
    </script>
</polymer-element>